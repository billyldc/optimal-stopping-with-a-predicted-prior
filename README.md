## Optimal stopping with a predicted prior — README

This repository contains numerical code, plotting utilities, and LP formulations used to study optimal-stopping rules under a predicted prior and the trade-off between "consistency" (alpha) and "robustness" (beta).

The code implements two parallel tracks used in the accompanying experiments and figures:

- "max_expect": numerical ODE-based approach that solves an implicit differential equation to produce an (alpha, beta) trade-off curve and plots C(u) (solution of an ODE) and the consistency-robustness Pareto curve.
- "max_prob": finite-support LP approach that builds and solves Gurobi linear programs to compute achievable (alpha, beta) pairs, construct hardness curves, and save/load precomputed alpha-beta data.
- "other_plots": miscellaneous plotting utilities and experimental drivers mentioned in the paper (not central to the main experiments).

Repository layout
-----------------

- `max_expect/`
	- `max_expect_algorithm.py` — solver for an implicit ODE for C(u), utilities to search for critical K (alpha), and routines to compute minimal ratios. Includes a CLI-style `if __name__ == '__main__'` example that enumerates beta values and plots the Pareto curve.
	- `max_expect_curve_plotter.py` — plotting helper that calls `optimal_alpha_beta` and draws the alpha-vs-beta curve with a tangent and a trivial baseline.

- `max_prob/`
	- `max_prob_algorithm.py` — compute the consistency-robustness curve for our algorithm \mathcal{A}. Includes a CLI-style `if __name__ == '__main__'` example that only draws the alpha-vs-beta curve for our algorithm.
	- `max_prob_hardness.py` —  compute the hardness curve by experiments. Builds Gurobi LPs to maximize alpha or beta given the other, can run experiments, save/load results under `output/`, and plot hardness curves. Includes a CLI-style `if __name__ == '__main__'` example that runs experiments and plots the hardness curve.
	- `output/` — saved alpha-beta data generated by the hardness computation and generated figures (created by experiments).
    - `max_prob_curve_plotter.py` — plotting helper that calls both `max_prob_algorithm` and `max_prob_hardness` to illustrate and compare algorithmic and hardness results.

- `LICENSE`, `__init__.py`, and this `README.md`.

Dependencies
------------

The codebase uses the following Python packages (tested on Python 3.8+):

- numpy
- scipy
- matplotlib
- gurobipy (optional — required to run LP-based experiments in `max_prob/`)

Install dependencies using pip in your virtualenv. Example:

```bash
# create and activate venv
python -m venv .venv
source .venv/bin/activate

# install essentials
pip install numpy scipy matplotlib

# install gurobipy only if you plan to run LP experiments (Gurobi license required)
# pip install gurobipy
```

Quick usage
-----------

1) Plot the ODE-based (max-expectation) Pareto curve

- Open a Python session or run the module directly:

```bash
python max_expect/max_expect_curve_plotter.py
```

This calls `optimal_alpha_beta` (the density and sampling parameters are set in the file) and draws alpha vs beta along with a trivial baseline.

2) Run the LP-based experiment and plot hardness curves

- If you have Gurobi installed and a valid license, run:

```bash
python max_prob/max_prob_hardness.py
python max_prob/max_prob_algorithm.py
```

`max_prob_hardness.alpha_beta_curve` can load precomputed data from `max_prob/output/` when `load_from_file=True` (the driver uses this to avoid re-running expensive LP sweeps). Set `load_from_file=False` to force recomputation.

important functions
------------------------------

- max_expect/max_expect_algorithm.py
	- solve_C_for_K(K, u0, u1, ...): numerically solves the implicit ODE for C(u) on [u0, u1].
	- search_optimal_K(...): binary search that brackets the critical K (alpha) separating solvable vs non-solvable ODE integration.
	- compute_min_ratio(alpha, C, lambda2, ...): computes a root problem and returns a minimal ratio used to derive a second alpha curve.

- max_prob/max_prob_hardness.py
	- class Distributions(probs, values, indices, prior_index): create truncated-support distributions used by the LP.
	- class LP_maxprob(n, F, alpha, beta): builds and solves Gurobi LPs to maximize the missing objective (alpha or beta).
	- experiment(...): run parametric LP experiments for a given pmf and sampling density.
	- class alpha_beta_curve: convenience wrapper to load/save/plot alpha-beta data and images.

Notes, tips and troubleshooting
------------------------------

- The ODE solver in `max_expect_algorithm.py` uses stiff integrators and high tolerances; adjust `n_points`, `rtol`, and `atol` if you see integration failures or very slow runs.
- LP experiments may be expensive for large support sizes `m` and long sequences `n`. The code contains an option to use multiprocessing; Gurobi licensing and resources limit parallel solves.
- The `max_prob_hardness` module attempts to load precomputed data from `max_prob/output/` when available. If you run experiments, results and plots are saved into that folder.

Reproducibility and examples
---------------------------

- Many of the plotting scripts include `if __name__ == '__main__':` examples that are ready to run after dependencies are installed.
- To quickly reproduce plots used in the repository, run the plotting driver modules shown in "Quick usage". If `load_from_file=True` the `max_prob` driver will reuse previously computed results.